services:
  postgres:
    image: postgres:16-alpine
    container_name: cleanplated-postgres
    environment:
      POSTGRES_DB: cleanplated
      POSTGRES_USER: cleanplated
      POSTGRES_PASSWORD: cleanplated
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cleanplated -d cleanplated"]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    container_name: cleanplated-redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cleanplated-backend
    environment:
      CLEANPLATED_RUN_MODE: api
      CLEANPLATED_ENABLE_BACKGROUND_INGESTION: "false"
      CLEANPLATED_HOST: 0.0.0.0
      CLEANPLATED_PORT: 8080
      CLEANPLATED_CORS_ORIGIN: http://localhost:15173
      CLEANPLATED_INGESTION_INTERVAL_HOURS: 24
      CLEANPLATED_SD_SOCRATA_BASE_URL: ${CLEANPLATED_SD_SOCRATA_BASE_URL:-https://internal-sandiegocounty.data.socrata.com}
      CLEANPLATED_SD_SOCRATA_DATASET_ID: ${CLEANPLATED_SD_SOCRATA_DATASET_ID:-c5ez-ufrd}
      CLEANPLATED_SD_SOCRATA_PAGE_SIZE: ${CLEANPLATED_SD_SOCRATA_PAGE_SIZE:-5000}
      CLEANPLATED_SD_SOCRATA_MAX_RECORDS: ${CLEANPLATED_SD_SOCRATA_MAX_RECORDS:-}
      CLEANPLATED_SD_SOCRATA_ACTIVE_ONLY: ${CLEANPLATED_SD_SOCRATA_ACTIVE_ONLY:-true}
      CLEANPLATED_SD_SOCRATA_TIMEOUT_SECS: ${CLEANPLATED_SD_SOCRATA_TIMEOUT_SECS:-20}
      CLEANPLATED_SD_SOCRATA_APP_TOKEN: ${CLEANPLATED_SD_SOCRATA_APP_TOKEN:-}
      CLEANPLATED_LA_INVENTORY_URL: ${CLEANPLATED_LA_INVENTORY_URL:-https://services.arcgis.com/RmCCgQtiZLDCtblq/arcgis/rest/services/Environmental_Health_Restaurant_and_Market_Inventory_12312025/FeatureServer}
      CLEANPLATED_LA_INSPECTIONS_URL: ${CLEANPLATED_LA_INSPECTIONS_URL:-https://services.arcgis.com/RmCCgQtiZLDCtblq/arcgis/rest/services/Environmental_Health_Restaurant_and_Market_Inspections_01012023_to_123120025/FeatureServer}
      CLEANPLATED_LA_VIOLATIONS_URL: ${CLEANPLATED_LA_VIOLATIONS_URL:-https://services.arcgis.com/RmCCgQtiZLDCtblq/arcgis/rest/services/Environmental_Health_Restaurant_and_Market_Violations_01012023_to_123120025/FeatureServer}
      CLEANPLATED_LA_PAGE_SIZE: ${CLEANPLATED_LA_PAGE_SIZE:-2000}
      CLEANPLATED_LA_MAX_RECORDS: ${CLEANPLATED_LA_MAX_RECORDS:-}
      CLEANPLATED_LA_TIMEOUT_SECS: ${CLEANPLATED_LA_TIMEOUT_SECS:-20}
      CLEANPLATED_LONG_BEACH_CLOSURES_URL: ${CLEANPLATED_LONG_BEACH_CLOSURES_URL:-https://www.longbeach.gov/health/inspections-and-reporting/inspections/restaurant-closures/}
      CLEANPLATED_LONG_BEACH_LIMIT: ${CLEANPLATED_LONG_BEACH_LIMIT:-8000}
      CLEANPLATED_LONG_BEACH_TIMEOUT_SECS: ${CLEANPLATED_LONG_BEACH_TIMEOUT_SECS:-20}
      CLEANPLATED_LONG_BEACH_LIVE_ENABLED: ${CLEANPLATED_LONG_BEACH_LIVE_ENABLED:-true}
      CLEANPLATED_LONG_BEACH_LIVE_PAGE_SIZE: ${CLEANPLATED_LONG_BEACH_LIVE_PAGE_SIZE:-25}
      CLEANPLATED_SBC_ARCGIS_URL: ${CLEANPLATED_SBC_ARCGIS_URL:-https://services.arcgis.com/OUDgwkiMsqiL8Tvp/arcgis/rest/services/San_Bernardio_Co_Food_Grades/FeatureServer}
      CLEANPLATED_RIVERSIDE_ARCGIS_URL: ${CLEANPLATED_RIVERSIDE_ARCGIS_URL:-}
      CLEANPLATED_LIVES_PAGE_SIZE: ${CLEANPLATED_LIVES_PAGE_SIZE:-1000}
      CLEANPLATED_LIVES_MAX_RECORDS: ${CLEANPLATED_LIVES_MAX_RECORDS:-}
      CLEANPLATED_LIVES_TIMEOUT_SECS: ${CLEANPLATED_LIVES_TIMEOUT_SECS:-20}
      CLEANPLATED_OC_CPRA_EXPORT_URL: ${CLEANPLATED_OC_CPRA_EXPORT_URL:-}
      CLEANPLATED_PASADENA_CPRA_EXPORT_URL: ${CLEANPLATED_PASADENA_CPRA_EXPORT_URL:-}
      CLEANPLATED_CPRA_TIMEOUT_SECS: ${CLEANPLATED_CPRA_TIMEOUT_SECS:-20}
      CLEANPLATED_OC_LIVE_ENABLED: ${CLEANPLATED_OC_LIVE_ENABLED:-true}
      CLEANPLATED_OC_LIVE_PATH: ${CLEANPLATED_OC_LIVE_PATH:-orange-county-back-li}
      CLEANPLATED_OC_LIVE_PAGE_SIZE: ${CLEANPLATED_OC_LIVE_PAGE_SIZE:-25}
      CLEANPLATED_OC_LIVE_MAX_RECORDS: ${CLEANPLATED_OC_LIVE_MAX_RECORDS:-30000}
      CLEANPLATED_OC_LIVE_PER_TERM_MAX_RECORDS: ${CLEANPLATED_OC_LIVE_PER_TERM_MAX_RECORDS:-20000}
      DATABASE_URL: ${DATABASE_URL:-postgres://cleanplated:cleanplated@postgres:5432/cleanplated}
      REDIS_URL: redis://redis:6379
    ports:
      - "18080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cleanplated-worker
    environment:
      CLEANPLATED_RUN_MODE: worker
      CLEANPLATED_INGESTION_INTERVAL_HOURS: 24
      CLEANPLATED_SD_SOCRATA_BASE_URL: ${CLEANPLATED_SD_SOCRATA_BASE_URL:-https://internal-sandiegocounty.data.socrata.com}
      CLEANPLATED_SD_SOCRATA_DATASET_ID: ${CLEANPLATED_SD_SOCRATA_DATASET_ID:-c5ez-ufrd}
      CLEANPLATED_SD_SOCRATA_PAGE_SIZE: ${CLEANPLATED_SD_SOCRATA_PAGE_SIZE:-5000}
      CLEANPLATED_SD_SOCRATA_MAX_RECORDS: ${CLEANPLATED_SD_SOCRATA_MAX_RECORDS:-}
      CLEANPLATED_SD_SOCRATA_ACTIVE_ONLY: ${CLEANPLATED_SD_SOCRATA_ACTIVE_ONLY:-true}
      CLEANPLATED_SD_SOCRATA_TIMEOUT_SECS: ${CLEANPLATED_SD_SOCRATA_TIMEOUT_SECS:-20}
      CLEANPLATED_SD_SOCRATA_APP_TOKEN: ${CLEANPLATED_SD_SOCRATA_APP_TOKEN:-}
      CLEANPLATED_LA_INVENTORY_URL: ${CLEANPLATED_LA_INVENTORY_URL:-https://services.arcgis.com/RmCCgQtiZLDCtblq/arcgis/rest/services/Environmental_Health_Restaurant_and_Market_Inventory_12312025/FeatureServer}
      CLEANPLATED_LA_INSPECTIONS_URL: ${CLEANPLATED_LA_INSPECTIONS_URL:-https://services.arcgis.com/RmCCgQtiZLDCtblq/arcgis/rest/services/Environmental_Health_Restaurant_and_Market_Inspections_01012023_to_123120025/FeatureServer}
      CLEANPLATED_LA_VIOLATIONS_URL: ${CLEANPLATED_LA_VIOLATIONS_URL:-https://services.arcgis.com/RmCCgQtiZLDCtblq/arcgis/rest/services/Environmental_Health_Restaurant_and_Market_Violations_01012023_to_123120025/FeatureServer}
      CLEANPLATED_LA_PAGE_SIZE: ${CLEANPLATED_LA_PAGE_SIZE:-2000}
      CLEANPLATED_LA_MAX_RECORDS: ${CLEANPLATED_LA_MAX_RECORDS:-}
      CLEANPLATED_LA_TIMEOUT_SECS: ${CLEANPLATED_LA_TIMEOUT_SECS:-20}
      CLEANPLATED_LONG_BEACH_CLOSURES_URL: ${CLEANPLATED_LONG_BEACH_CLOSURES_URL:-https://www.longbeach.gov/health/inspections-and-reporting/inspections/restaurant-closures/}
      CLEANPLATED_LONG_BEACH_LIMIT: ${CLEANPLATED_LONG_BEACH_LIMIT:-8000}
      CLEANPLATED_LONG_BEACH_TIMEOUT_SECS: ${CLEANPLATED_LONG_BEACH_TIMEOUT_SECS:-20}
      CLEANPLATED_LONG_BEACH_LIVE_ENABLED: ${CLEANPLATED_LONG_BEACH_LIVE_ENABLED:-true}
      CLEANPLATED_LONG_BEACH_LIVE_PAGE_SIZE: ${CLEANPLATED_LONG_BEACH_LIVE_PAGE_SIZE:-25}
      CLEANPLATED_SBC_ARCGIS_URL: ${CLEANPLATED_SBC_ARCGIS_URL:-https://services.arcgis.com/OUDgwkiMsqiL8Tvp/arcgis/rest/services/San_Bernardio_Co_Food_Grades/FeatureServer}
      CLEANPLATED_RIVERSIDE_ARCGIS_URL: ${CLEANPLATED_RIVERSIDE_ARCGIS_URL:-}
      CLEANPLATED_LIVES_PAGE_SIZE: ${CLEANPLATED_LIVES_PAGE_SIZE:-1000}
      CLEANPLATED_LIVES_MAX_RECORDS: ${CLEANPLATED_LIVES_MAX_RECORDS:-}
      CLEANPLATED_LIVES_TIMEOUT_SECS: ${CLEANPLATED_LIVES_TIMEOUT_SECS:-20}
      CLEANPLATED_OC_CPRA_EXPORT_URL: ${CLEANPLATED_OC_CPRA_EXPORT_URL:-}
      CLEANPLATED_PASADENA_CPRA_EXPORT_URL: ${CLEANPLATED_PASADENA_CPRA_EXPORT_URL:-}
      CLEANPLATED_CPRA_TIMEOUT_SECS: ${CLEANPLATED_CPRA_TIMEOUT_SECS:-20}
      CLEANPLATED_OC_LIVE_ENABLED: ${CLEANPLATED_OC_LIVE_ENABLED:-true}
      CLEANPLATED_OC_LIVE_PATH: ${CLEANPLATED_OC_LIVE_PATH:-orange-county-back-li}
      CLEANPLATED_OC_LIVE_PAGE_SIZE: ${CLEANPLATED_OC_LIVE_PAGE_SIZE:-25}
      CLEANPLATED_OC_LIVE_MAX_RECORDS: ${CLEANPLATED_OC_LIVE_MAX_RECORDS:-30000}
      CLEANPLATED_OC_LIVE_PER_TERM_MAX_RECORDS: ${CLEANPLATED_OC_LIVE_PER_TERM_MAX_RECORDS:-20000}
      DATABASE_URL: ${DATABASE_URL:-postgres://cleanplated:cleanplated@postgres:5432/cleanplated}
      REDIS_URL: redis://redis:6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: http://localhost:18080
        VITE_GOOGLE_MAPS_API_KEY: ${VITE_GOOGLE_MAPS_API_KEY:-}
    container_name: cleanplated-frontend
    environment:
      GA_MEASUREMENT_ID: ${GA_MEASUREMENT_ID:-}
    ports:
      - "15173:8080"
    depends_on:
      - backend

volumes:
  postgres_data:
